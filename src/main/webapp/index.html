<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tomcat WebSocket</title>
<script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="GameSettings.js"></script>
<script src="Card.js"></script>
<script src="CardZone.js"></script>
<script src="Player.js"></script>
<script src="Cookie.js"></script>
<script>

</script>

<style>
.wrapper {
	display: flex;
	justify-content: center;
	height: 100vh;
	align-items: center;
	min-width: 100vw;
	position: relative;
}

body {
	height: 100vh;
}

.form-wrapper {
	background-color: white;
	border: 1px solid #d9d9d9;
	padding: 20px 10px;
	width: 400px;
	border-radius: 3px;
}

.form-wrapper button {
	margin-top: 10px;
	width: 100%;
}

.form-wrapper input {
	margin-top: 10px;
}

.form-header {
	font-size: 20px;
	text-align: center;
}

.left-side {
	width: 100%;
	height: 700px;
	background-color: red;
}

.menu {
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	height: 100%;
}

.menu button {
	margin-bottom: 10px;
	width: 200px;
}

canvas {
	background-color: black;
	background-size: 50px 100px;
	display: block;
	margin: auto;
	image-rendering: pixelated;
}

#game-container {
	display: none;
}

.log {
	background-color: graytext;
	width: 100%;
	height: 200px;
	width: 100%;
}

textarea {
	width: 100%;
	height: 100%;
}

.newGameForm, .joinGameForm {
	position: absolute;
	z-index: 2;
	height: 300px;
	width: 600px;
	background-color: white;
	text-align: center;
	display: none;
}

.curtain {
	display: none;
	background-color: black;
	opacity: 0.7;
	height: 100%;
	width: 100%;
	position: absolute;
}

.h-auto {
	height: auto !important;
}

.playBtn {
	display: none;
}
</style>


</head>
<body>

	<div class="wrapper">
		<div class="form-wrapper">
			<div class="mb-4 form-header">
				<span>ðŸ’Š VIRUS ðŸ¦ </span>
			</div>

			<button id="joinBtn" class="btn btn-primary btn-block">Join
				Game</button>
			<!-- <button id="newGameBtn" class="btn btn-primary btn-block"
				onclick="showNewGameForm();">Host Game</button> -->
		</div>
		<div class="curtain"></div>
		<div class="joinGameForm">
			<h1>Join Game</h1>

			<input type="text" class="form-control" id="nickname"
				placeholder="Nickname"> <input type="text"
				class="form-control" id="gameId" placeholder="paste id here...">
			<div>
				<button class="btn btn-primary btn-block" id="cancelBtn">Cancel</button>
				<button class="btn btn-primary btn-block" id="connectBtn">Connect</button>
			</div>

		</div>
		<!-- <div class="newGameForm">
			<h1>New Game</h1>
			
				<input type="text" class="form-control" id="nickname"
					placeholder="Nickname">
			
			<label for="numPlayers">Choose number of players:</label>
			 <select id="numPlayers">
				<option value="2">two</option>
				<option value="3">three</option>
				<option value="4">four</option>
				<option value="5">five</option>
				<option value="6">six</option>
			</select>
			<div>
				<button class="btn btn-primary btn-block" onclick="cancel();">Cancel</button>
				<button class="btn btn-primary btn-block" onclick="createNewGame();">Create Game</button>
				<button class="btn btn-primary btn-block playBtn" onclick="play();">Play</button>
			</div>

		</div>
		 -->
	</div>




	<div id="game-container">
		<div class="left-side">
			<div class="menu">
				<button id="change">WymieÅ„ karty</button>
				<button id="skip">Nic nie rÃ³b</button>
				<label for="players">UÅ¼yj karty na graczu</label>
				<select id="players"></select>
				<button id="useCard">UÅ¼yj karty</button>
				
			</div>
			<div class="log">
				<textarea id="echoText" rows="5" cols="30"></textarea>
			</div>
		</div>
		<div id="right-side"></div>
	</div>
</body>

<script type="text/javascript">
(function(){
	let game;
	let webSocket;
	let players;
	let cards = [];
	let x = false;
	
	function joinGame(){
		
		if (webSocket != undefined){
			return
			};
		console.log(webSocket)
		let url='http://localhost:8080/ServerGame/rest/game/search/';
		let gameid = $('#gameId').val();
		let username = $('#nickname').val();
		url += gameid;
		
		
		
			$.ajax({
			    url: url, //gdzie siÄ™ Å‚Ä…czymy
			    method: "get", //typ poÅ‚Ä…czenia, domyÅ›lnie get
			})
			.done(res => { //reagujÄ™ na odpowiedÅº - o tym poniÅ¼ej
			    if (res == "1"){//jesli istnieje gra w bazie
			    	 webSocket = new WebSocket("ws://localhost:8080/ServerGame/basicEndpoint/" + gameid + "?clientId=" + "kutas"+ "&username=" + username);
			    	 webSocket.onmessage = function(message) {
		    		 let data = JSON.parse(message.data);
		    		 let isPlaying = data.player.playable;
		    		 
		 			 $('#game-container .menu button').prop('disabled', !isPlaying);
		    		 
		    		 console.log(data)
		    		 messageHandler(data);
		    		};
			    
			    		
			    }
			});
	}

	
	function showJoinGameForm(){
		$('.joinGameForm').show();
		$('.curtain').show();
	}

	function cancel(){
		$('.joinGameForm').hide();
		$('.newGameForm').hide();
		$('.curtain').hide();
	}

	function showNewGameForm(){
		$('.newGameForm').show();
		$('.curtain').show();
	}
	
	function onChange(){
		let message = "CHANGE";
		
		let tinted = false;
		for (var i = 0; i < cards.length; i++){
			if (cards[i].isTinted){
				tinted = true;
				message += "," + i;
			}
		}
		webSocket.send(message);
	}
	
	function useCard(){
		x = !x;
		
	}
	
	function skip(){
		webSocket.send("SKIP");
	}
	

	function createNewGame(){
		const numOfPlayers = $('#numPlayers').val();
		let url='http://localhost:8080/ServerGame/rest/game/new/' + numOfPlayers;
		
		$.ajax({
		    url: url, //gdzie siÄ™ Å‚Ä…czymy
		    method: "post", //typ poÅ‚Ä…czenia, domyÅ›lnie get
		})
		.done(res => { //reagujÄ™ na odpowiedÅº - o tym poniÅ¼ej
	    	webSocket = new WebSocket("ws://localhost:8080/ServerGame/basicEndpoint/" + res);
	    	webSocket.onmessage = function(message) {
	    		console.log(message);
	    	};
	    	//cancel();
	    //	$('.wrapper').addClass('h-auto');
	    	//$('.form-wrapper').hide();
		});


	}
	
	function handleConnect(data){
		
		
	}
	
	function handleStart(data){
		$('.wrapper').hide();
		
		let playerNumber = data.game.numOfPlayers;
		
		for (let i = 1; i <= playerNumber; i++){
			$('#players').append($('<option>', {
			    value: i,
			    text: "Player" + i
			}));
		}
		
	
		let config = {
				type: Phaser.AUTO,
				parent: 'right-side',
				backgroundColor: '#000000',
				height: CANVAS_HEIGHT,
				width: CANVAS_WIDTH,
				pixelArt: true,
				
				scene: {
					create: create,
					preload: preload,
					update : update
					
				}
			};



		function preload() {
			this.load.image('1', 'assets/organs/1.png');
			this.load.image('2', 'assets/organs/2.png');
			this.load.image('3', 'assets/organs/3.png');
			this.load.image('4', 'assets/organs/4.png');
			this.load.image('5', 'assets/organs/5.png');
			
			this.load.image('6', 'assets/viruses/6.png');
			this.load.image('7', 'assets/viruses/7.png');
			this.load.image('8', 'assets/viruses/8.png');
			this.load.image('9', 'assets/viruses/9.png');
			this.load.image('10', 'assets/viruses/10.png');
			
			
			this.load.image('11', 'assets/remedies/11.png');
			this.load.image('12', 'assets/remedies/12.png');
			this.load.image('13', 'assets/remedies/13.png');
			this.load.image('14', 'assets/remedies/14.png');
			this.load.image('15', 'assets/remedies/15.png');
			
			this.load.image('16', 'assets/actions/16.png');
			this.load.image('17', 'assets/actions/17.png');
			this.load.image('18', 'assets/actions/18.png');
			this.load.image('19', 'assets/actions/19.png');
			this.load.image('20', 'assets/actions/20.png');
		}


		function create() {
	       let positions = PLAYERS_POSITIONS.get(parseInt(playerNumber));
	       console.log(positions)
	       players = [];
	       console.log(positions)
			positions.forEach(e => {
				players.push(new Player(this, e[0], e[1]));
			});
	       
	       data.player.hand.cards.forEach((e, i)=>{
	    	   cards.push(new Card(this, 200 * (i + 1), 700, e.uniqueTypeID));
	    	  
	       })
		}
		
		function update(){
			if (x){
				
			new Card(this, 39 * (2 + 1), 700, 2);
					}
			else{
				
			new Card(this, 39 * (2 + 1), 700, 5);
			}
		}
				
			
	 game =  new Phaser.Game(config);
  	 $('#game-container').css('display', 'flex')
	}
	
	function handleGameUpdate(data){
		let karty = data.player.hand.cards;
		
		for (let i = 0; i <cards.length; i++){
			cards[i].setTexture(karty[i].uniqueTypeID);
			cards[i].clearTint();
		}
		
		 
		
	}
	
    function messageHandler(data){
    	switch(data.state){
    	
    	case "CONNECT":
            handleConnect(data);
            break;
        case "START":
        	handleStart(data);
        	break;
        case "UPDATE":
        	 handleGameUpdate(data);
    	}
	}
	
	$('#joinBtn').on("click", showJoinGameForm);
	$('#connectBtn').on("click", joinGame);
	$('#cancelBtn').on("click", cancel);
	$('#change').on("click", onChange);
	$('#skip').on("click", skip);
	$('#useCard').on("click", useCard);
	
})();







/*
	var webSocket = new WebSocket(
			"ws://localhost:8080/ServerGame/basicEndpoint");
	var echoText = document.getElementById("echoText");
	echoText.value = "";
	var message = document.getElementById("message");
	webSocket.onopen = function(message) {
		wsOpen(message);
	};
	webSocket.onmessage = function(message) {
		wsGetMessage(message);
	};
	webSocket.onclose = function(message) {
		wsClose(message);
	};
	webSocket.onerror = function(message) {
		wsError(message);
	};
	function wsOpen(message) {
		echoText.value += "Connected ... \n";
	}
	function wsSendMessage() {
		webSocket.send(message.value);
		echoText.value += "Message sended to the server : " + message.value
				+ "\n";
		message.value = "";
	}
	function wsCloseConnection() {
		webSocket.close();
	}
	function wsGetMessage(message) {
		echoText.value += "Message received from to the server : "
				+ message.data + "\n";
	}
	function wsClose(message) {
		echoText.value += "Disconnect ... \n";
	}

	function wsError(message) {
		echoText.value += "Error ... \n";
	}
	
	*/
	
	
</script>

</html>